!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@tsed/core"),require("@tsed/schema")):"function"==typeof define&&define.amd?define(["@tsed/core","@tsed/schema"],t):"object"==typeof exports?exports["json-mapper"]=t(require("@tsed/core"),require("@tsed/schema")):e["json-mapper"]=t(e["@tsed/core"],e["@tsed/schema"])}(self,((e,t)=>(()=>{"use strict";var r={803:t=>{t.exports=e},953:e=>{e.exports=t}},n={};function o(e){var t=n[e];if(void 0!==t)return t.exports;var s=n[e]={exports:{}};return r[e](s,s.exports,o),s.exports}o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return(()=>{function e(e,t,r,n){var o,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(o=e[c])&&(i=(s<3?o(i):s>3?o(t,r,i):o(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i}o.r(s),o.d(s,{AfterDeserialize:()=>g,ArrayMapper:()=>c,BeforeDeserialize:()=>b,CastError:()=>y,DateMapper:()=>l,JsonMapper:()=>i,JsonMapperContext:()=>S,JsonMapperSettings:()=>z,MapMapper:()=>p,OnDeserialize:()=>T,OnSerialize:()=>O,PrimitiveMapper:()=>f,SetMapper:()=>d,SymbolMapper:()=>m,alterAfterDeserialize:()=>j,alterBeforeDeserialize:()=>x,classToPlainObject:()=>M,deserialize:()=>J,getJsonMapperTypes:()=>n,plainObjectToClass:()=>E,registerJsonTypeMapper:()=>r,serialize:()=>P}),Object.create,Object.create;const t=new Map;function r(e,r){t.set(e,new r)}function n(){return t}function i(...e){return t=>{e.forEach((e=>{r(e,t)}))}}let c=class{deserialize(e,t){return[].concat(e).map((e=>t.next(e)))}serialize(e,t){return[].concat(e).map((e=>t.next(e)))}};c=e([i(Array)],c);var a=o(803);let l=class{deserialize(e){return(0,a.isBoolean)(e)||null==e?e:new Date(e)}serialize(e){return new Date(e).toISOString()}};l=e([i(Date)],l);let p=class{deserialize(e,t){const r=new Map;return(0,a.objectKeys)(e).forEach((n=>{r.set(n,t.next(e[n]))})),r}serialize(e,t){const r={};return e.forEach(((e,n)=>r[n]=t.next(e))),r}};function u(e){return[null,"null"].includes(e)}p=e([i(Map)],p);class y extends Error{name="CAST_ERROR";constructor(e){super(`Cast error. ${e}`)}}let f=class{deserialize(e,t){switch(t.type){case String:return null===e?null:""+e;case BigInt:return u(e)?null:BigInt(e);case Number:if(u(e))return null;const t=+e;if(isNaN(t))throw new y("Expression value is not a number.");return t;case Boolean:if(["true","1",!0].includes(e))return!0;if(["false","0",!1].includes(e))return!1;if(u(e))return null;if(void 0===e)return;return!!e}}serialize(e){return e}};f=e([i(String,Number,Boolean,BigInt)],f);let d=class{deserialize(e,t){const r=new Set;return(0,a.objectKeys)(e).forEach((n=>{r.add(t.next(e[n]))})),r}serialize(e,t){const r=[];return e.forEach((e=>r.push(t.next(e)))),r}};d=e([i(Set)],d);let m=class{deserialize(e){return Symbol.for(e)}serialize(e){return e.toString().replace("Symbol(","").replace(")","")}};m=e([i(Symbol)],m);var h=o(953);function g(e){return(0,h.JsonEntityFn)((t=>{t.schema.$hooks.on("afterDeserialize",e)}))}function b(e){return(0,h.JsonEntityFn)((t=>{t.schema.$hooks.on("beforeDeserialize",e)}))}function T(e){return(0,h.JsonEntityFn)((t=>{t.schema.$hooks.on("onDeserialize",e)}))}function O(e){return(0,h.JsonEntityFn)((t=>{t.schema.$hooks.on("onSerialize",e)}))}class S{collectionType;type;options;_next;constructor({type:e,collectionType:t,next:r,options:n}){this.type=e,this.collectionType=(0,a.isCollection)(t)?t:void 0,this._next=r,this.options=n}next(e){return this._next(e,{...this.options,type:this.type})}}const z={disableUnsecureConstructor:!0,additionalProperties:!1};function j(e,t,r){return t?.$hooks?.alter("afterDeserialize",e,[r])}function x(e,t,r){return t?.$hooks?.alter("beforeDeserialize",e,[r])}function E(e,t){if((0,a.isEmpty)(e))return e;const{type:r,store:n=h.JsonEntityStore.from(r)}=t,o=(0,h.getProperties)(n,{...t,withIgnoredProps:!0});let s=new Set((0,a.objectKeys)(e));const i=function(e,t,r){const n=t.schema.get("additionalProperties");return(0,a.isBoolean)(n)||(0,a.isClass)(n)?n:0===e||!!r.additionalProperties}(o.size,n,t);e=x(e,n.schema,t);const c=new r(t.disableUnsecureConstructor?{}:e);if(o.forEach((r=>{const n=t.useAlias&&r.parent.schema.getAliasOf(r.propertyName)||r.propertyName;if(s.delete(n),(0,h.alterIgnore)(r.schema,t))return;let o=function(e,t,r){return e.$hooks.alter("onDeserialize",t,[r])}(r.schema,e[n],{...t,self:e});o=o===e[n]?J(o,{...t,store:r,self:e,collectionType:r.collectionType}):o,r.isGetterOnly()||(void 0!==o?c[r.propertyName]=o:t.partial&&delete c[r.propertyName])})),i)if((0,a.isBoolean)(i))s.forEach((t=>{c[t]=e[t]}));else{const r=i.getComputedType();s.forEach((n=>{c[n]=J(e[n],{...t,type:r})}))}return j(c,n.schema,t)}function v(e){return e.store instanceof h.JsonPropertyStore?v(function(e,t){const r={...t,store:void 0,type:e.computedType};if(e.itemSchema.isDiscriminator&&(r.type=e.itemSchema.discriminator()),e.schema.hasGenerics)r.nestedGenerics=e.schema.nestedGenerics;else if(e.schema.isGeneric&&t.nestedGenerics){const[n=[],...o]=t.nestedGenerics,s=e.parent.schema.genericLabels||[];r.type=n[s.indexOf(e.schema.genericType)]||Object,r.type instanceof h.JsonSchema&&(r.type=r.type.getTarget()),r.nestedGenerics=o}return r}(e.store,e)):e.store instanceof h.JsonParameterStore?v(function(e,t){return{...t,store:void 0,type:e.getBestType(),collectionType:e.collectionType,groups:e.parameter.groups,genericTypes:e.nestedGenerics[0],nestedGenerics:e.nestedGenerics}}(e.store,e)):(e.store instanceof h.JsonEntityStore?(e.type=e.store.computedType,e.collectionType=e.store.collectionType,e.store=void 0):(0,a.isClass)(e.type)&&h.JsonEntityStore.from(e.type).schema.isDiscriminator&&(e.type=h.JsonEntityStore.from(e.type).schema.discriminator()),{groups:!1,useAlias:!0,...e,additionalProperties:(0,a.getValue)(e,"additionalProperties",z.additionalProperties),disableUnsecureConstructor:(0,a.getValue)(e,"disableUnsecureConstructor",z.disableUnsecureConstructor),partial:!!e.groups&&e.groups.includes("partial"),type:e.type?e.type:void 0,types:e.types?e.types:n()})}function J(e,t={}){if(!function(e,t){return!(t.collectionType&&(0,a.isNil)(e)||void 0===e||(0,a.isEmpty)(t.type)||t.type===Object&&!t.collectionType)}(e,t=v(t)))return e;if(!t.collectionType&&(0,a.isArray)(e)&&(t.collectionType=Array),t.collectionType){if(!t.types?.has(t.collectionType))throw new Error(`${(0,a.nameOf)(t.collectionType)} is not supported by JsonMapper.`);return function(e,t){const{types:r,type:n=Object,collectionType:o}=t,s=new S({type:n,collectionType:o,options:t,next:(e,{collectionType:t,...r})=>J(e,r)});return r?.get(t.collectionType)?.deserialize(e,s)}(e,t)}if(t.types?.has(t.type))return function(e,t){const{types:r,type:n=Object}=t,o=new S({type:n,options:t,next:(e,{type:t,...r})=>J(e,r)});return r?.get(n)?.deserialize(e,o)}(e,t);if(t.type instanceof h.Discriminator){const r=t.type,n=e[r.propertyName],o=r.getType(n);return E(e,{...t,type:o})}return E(e,t)}function A(e,t){if(!(0,a.isNil)(t)&&e.type!==Object&&!(0,a.isCollection)(e.type))return e.type}function M(e,t){const{useAlias:r=!0,type:n,...o}=t,s=h.JsonEntityStore.from(n||e),i=!!s.schema.get("additionalProperties"),c=function(e,t){const r=Array.from((0,h.getPropertiesStores)(e).entries());return r.length||(0,a.objectKeys)(t).forEach((t=>{const n=h.JsonEntityStore.from(e.target,t);r.push([t,n])})),r}(s,e),l=new Set,p=c.reduce(((t,[n,s])=>{l.add(n);const i=s.schema;if((0,h.alterIgnore)(i,{useAlias:r,...o,self:e}))return t;let c=function(e,t,r){return e.$hooks.alter("onSerialize",t,[r])}(i,e[n],{useAlias:r,...o,self:e});return c=P(c,{useAlias:r,self:e,type:c===e[n]?A(s,c):void 0,collectionType:s.collectionType,...o}),void 0===c?t:(n=r&&s.parent.schema.getAliasOf(n)||n,{...t,[n]:c})}),{});if(s.discriminatorAncestor){const e=s.discriminatorAncestor.schema.discriminator();p[e.propertyName]||(p[e.propertyName]=e.getDefaultValue(s.target))}return i&&(0,a.objectKeys)(e).forEach((t=>{l.has(t)||(p[t]=e[t])})),p}function D(e){return"function"==typeof e.toJSON}function P(e,{type:t,collectionType:r,groups:o=!1,...s}={}){if((0,a.isEmpty)(e))return e;let i=t;const c=s.types?s.types:n();if(s.groups=o,function(e){return D(e)&&e.$isMongooseModelPrototype||e._bsontype}(e))return e.toJSON(s);if(D(e)&&!function(e){return e&&e?._isAMomentObject}(e)&&!(0,a.isDate)(e))return P(e.toJSON(),{...s,type:(0,a.classOf)(e)});(0,a.isCollection)(e)?s.collectionType||(i=(0,a.classOf)(e),s.type=t,s.collectionType=i):s.type=i=function(e,t){const r=(0,a.classOf)(t);return r&&!(0,a.isClassObject)(r)?r:e||Object}(i,e);const l=new S({type:i,options:s,next:e=>P(e,{...s,collectionType:void 0,type:s.type})}),p=c.get(i)||c.get((0,a.nameOf)(i));return p?p.serialize(e,l):e?._isAMomentObject?e.toJSON():(0,a.isArray)(e)?c.get(Array)?.serialize(e,l):(0,a.isClassObject)(i)?function(e,t){return function(e){return Object.entries(e).filter((([,e])=>!(0,a.isFunction)(e)))}(e).reduce(((e,[r,n])=>({...e,[r]:P(n,t)})),{})}(e,s):M(e,s)}})(),s})()));
//# sourceMappingURL=json-mapper.umd.min.js.map